<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Book Venues - CoachMePlay</title>
<link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}" />
<style>
  body {
    font-family: 'Poppins', sans-serif;
    background: #f0f4f8;
    margin: 0;
    color: #22223a;
  }
  .navbar {
    background: #2563eb;
    padding: 15px 0;
    box-shadow: 0 3px 16px rgba(37, 99, 235, 0.12);
  }
  .navbar .container {
    max-width: 1200px;
    margin: auto;
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0 24px;
  }
  .navbar-brand {
    color: white;
    font-weight: 700;
    font-size: 24px;
    letter-spacing: 1px;
    text-decoration: none;
  }
  .navbar-menu {
    list-style: none;
    display: flex;
    gap: 18px;
    margin: 0;
    padding: 0;
  }
  .navbar-menu a {
    color: white;
    font-weight: 600;
    font-size: 16px;
    padding: 6px 16px;
    border-radius: 6px;
    text-decoration: none;
    transition: background 0.16s, color 0.16s;
  }
  .navbar-menu a:hover,
  .navbar-menu a.active {
    background: #10b981;
    color: white;
  }
  .dashboard {
    max-width: 1200px;
    margin: 20px auto;
    padding: 20px;
  }
  .welcome {
    background: linear-gradient(135deg, #2563eb 0%, #10b981 100%);
    color: white;
    padding: 32px 30px;
    border-radius: 14px;
    margin-bottom: 30px;
    box-shadow: 0 10px 30px rgba(37, 99, 235, 0.2);
  }
  .welcome h1 {
    margin: 0 0 6px 0;
    font-weight: 700;
    font-size: 2.4rem;
  }
  .welcome p {
    margin: 0;
    font-weight: 400;
    font-size: 1.25rem;
    opacity: 0.9;
  }
  .category-filter {
    display: flex;
    gap: 16px;
    margin-bottom: 30px;
    flex-wrap: wrap;
  }
  .filter-btn {
    padding: 14px 32px;
    border: 2px solid #e0e0e0;
    background: white;
    border-radius: 32px;
    cursor: pointer;
    transition: all 0.3s ease;
    font-weight: 700;
    font-size: 15px;
    color: #555;
    user-select: none;
  }
  .filter-btn:hover {
    background: #eef5ff;
    border-color: #2563eb;
    color: #2563eb;
  }
  .filter-btn.active {
    background: linear-gradient(135deg, #2563eb 0%, #10b981 100%);
    color: white;
    border-color: transparent;
  }
  .dashboard-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill,minmax(320px,1fr));
    gap: 24px;
  }
  .venue-card {
    background: white;
    border-radius: 16px;
    overflow: hidden;
    box-shadow: 0 10px 30px rgba(0,0,0,0.05);
    transition: all 0.3s ease;
    cursor: pointer;
  }
  .venue-card:hover {
    box-shadow: 0 18px 48px rgba(37, 99, 235, 0.25);
    transform: translateY(-4px);
  }
  .venue-image {
    width: 100%;
    height: 220px;
    object-fit: cover;
    background: linear-gradient(135deg, #2563eb 0%, #10b981 100%);
  }
  .venue-info {
    padding: 24px;
  }
  .venue-type {
    display: inline-block;
    padding: 6px 16px;
    background: #2563eb;
    color: white;
    border-radius: 16px;
    font-size: 12px;
    font-weight: 700;
    margin-bottom: 14px;
    text-transform: uppercase;
  }
  .venue-name {
    font-weight: 700;
    font-size: 22px;
    margin-bottom: 8px;
    color: #22223a;
  }
  .venue-location {
    color: #666;
    font-size: 14px;
    margin-bottom: 12px;
  }
  .venue-details {
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .venue-price {
    font-size: 20px;
    font-weight: 700;
    color: #10b981;
  }
  .book-btn {
    padding: 14px 36px;
    background: linear-gradient(135deg, #2563eb 0%, #10b981 100%);
    color: white;
    border: none;
    border-radius: 18px;
    cursor: pointer;
    font-weight: 700;
    font-size: 16px;
    transition: all 0.3s ease;
  }
  .book-btn:hover {
    transform: scale(1.05);
    box-shadow: 0 12px 30px rgba(37, 99, 235, 0.35);
  }
  .stats-section {
    display: grid;
    grid-template-columns: repeat(auto-fit,minmax(280px,1fr));
    gap: 20px;
    margin-bottom: 30px;
  }
  .stat-card {
    background: white;
    padding: 26px 30px;
    border-radius: 16px;
    box-shadow: 0 10px 30px rgba(37,99,235,0.1);
    text-align: center;
  }
  .stat-number {
    font-size: 36px;
    font-weight: 700;
    color: #10b981;
    margin: 12px 0 8px 0;
  }
  .stat-label {
    color: #555;
    font-weight: 600;
    font-size: 14px;
    letter-spacing: 1px;
  }
  .loading {
    text-align: center;
    color: #999;
    padding: 60px;
    font-size: 18px;
    grid-column: 1 / -1;
  }
  .time-slot-btn {
    padding: 14px;
    border: 2px solid;
    border-radius: 12px;
    font-weight: 700;
    transition: all 0.3s ease;
    font-size: 14px;
    min-width: 120px;
    cursor: pointer;
    user-select: none;
  }
  .time-slot-btn:not(:disabled):hover {
    transform: scale(1.05);
  }
  .time-slot-btn:disabled {
    cursor: not-allowed;
    opacity: 0.6;
  }

        .footer {
            background: #2563eb;
            padding: 24px 0 16px 0;
            text-align: center;
            margin-top: 48px;
            color: #fff;
            font-size: 16px;
            font-weight: 500;
            box-shadow: 0 -3px 14px #10b98144;
        }
        .footer p {
            margin: 6px 0;
            font-weight: 600;
            letter-spacing: 1px;
        }
        
</style>
</head>
<body>

<nav class="navbar">
  <div class="container">
      <a href="/" class="navbar-brand">CoachMePlay</a>
      <ul class="navbar-menu">
          <li><a href="/athlete/dashboard">Dashboard</a></li>
          <li><a href="/venues" class="active">Venues</a></li>
          <li><a href="/my-bookings">My Bookings</a></li>
          <li><a href="/athlete/profile">Profile</a></li>
          <li class="notification-wrapper">
              <a href="#" id="notificationBell" class="notification-bell">
                  Notifications
                  <span id="notificationBadge" class="notification-badge">0</span>
              </a>
              <div id="notificationDropdown" class="notification-dropdown">
                  <div class="notification-header">
                      <h4>Notifications</h4>
                      <a href="#" onclick="markAllAsRead(); return false;" class="mark-all-read">Mark all read</a>
                  </div>
                  <div id="notificationList" class="notification-list">
                      <div class="notification-item empty">Loading...</div>
                  </div>
              </div>
          </li>
          <li><a href="#" onclick="logout(); return false;">Logout</a></li>
      </ul>
  </div>
</nav>

<div class="dashboard">
  <div class="welcome">
      <h1>üèüÔ∏è Book Sports Venues</h1>
      <p>Find and reserve the perfect facility for your training</p>
  </div>

  <div class="stats-section">
      <div class="stat-card">
          <div style="font-size: 40px;">üèüÔ∏è</div>
          <div class="stat-number" id="totalVenues">0</div>
          <div class="stat-label">Available Venues</div>
      </div>
      <div class="stat-card">
          <div style="font-size: 40px;">üèãÔ∏è</div>
          <div class="stat-number" id="venueTypes">0</div>
          <div class="stat-label">Venue Types</div>
      </div>
      <div class="stat-card">
          <div style="font-size: 40px;">üí∞</div>
          <div class="stat-number" id="avgRate">‚Çπ0</div>
          <div class="stat-label">Avg Hourly Rate</div>
      </div>
  </div>

  <div class="category-filter">
      <button class="filter-btn active" onclick="filterVenues(null, this)">All Venues</button>
      <button class="filter-btn" onclick="filterVenues('gym', this)">üèãÔ∏è Gym</button>
      <button class="filter-btn" onclick="filterVenues('court', this)">üèÄ Court</button>
      <button class="filter-btn" onclick="filterVenues('field', this)">‚öΩ Field</button>
      <button class="filter-btn" onclick="filterVenues('pool', this)">üèä Pool</button>
      <button class="filter-btn" onclick="filterVenues('indoor', this)">üè∏ Indoor</button>
      <button class="filter-btn" onclick="filterVenues('outdoor', this)">üå≥ Outdoor</button>
  </div>

  <div class="dashboard-grid" id="venuesGrid">
      <p class="loading">Loading venues...</p>
  </div>
</div>

<!-- Booking Modal -->
<div id="bookingModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; align-items: center; justify-content: center; overflow-y: auto; padding: 20px;">
    <div style="background: white; padding: 30px; border-radius: 12px; width: 90%; max-width: 700px; max-height: 90vh; overflow-y: auto;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h2 style="margin: 0; color: #2563eb;">Book Venue</h2>
            <button onclick="closeBookingModal()" style="background: none; border: none; font-size: 32px; cursor: pointer; color: #999; line-height: 1;">√ó</button>
        </div>
        <h3 id="bookingVenueName" style="color: #10b981; margin-bottom: 20px;"></h3>
        
        <form id="bookingForm">
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 5px; font-weight: 600;">Select Date *</label>
                <input type="date" id="bookingDate" required style="width: 100%; padding: 10px; border: 1px solid #e0e0e0; border-radius: 8px;">
            </div>

            <!-- Time Slots Display -->
            <div id="timeSlotsSection" style="display: none; margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 10px; font-weight: 600;">Select Time Slots (6 AM - 10 PM)</label>
                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <div style="display: flex; gap: 15px; flex-wrap: wrap; margin-bottom: 10px;">
                        <div style="display: flex; align-items: center; gap: 5px;">
                            <div style="width: 20px; height: 20px; background: #10b981; border-radius: 4px;"></div>
                            <span style="font-size: 13px;">Available</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 5px;">
                            <div style="width: 20px; height: 20px; background: #dc2626; border-radius: 4px;"></div>
                            <span style="font-size: 13px;">Booked</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 5px;">
                            <div style="width: 20px; height: 20px; background: #2563eb; border: 2px solid #2563eb; border-radius: 4px;"></div>
                            <span style="font-size: 13px;">Selected</span>
                        </div>
                    </div>
                    <div id="timeSlotsGrid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px;"></div>
                </div>

            <!-- Hidden time inputs for form submission -->
            <input type="hidden" id="startTime" required>
            <input type="hidden" id="endTime" required>

            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; font-weight: 600;">Payment Method *</label>
                <select id="paymentMethod" required style="width: 100%; padding: 10px; border: 1px solid #e0e0e0; border-radius: 8px;">
                    <option value="cash">Cash</option>
                    <option value="card">Card</option>
                    <option value="upi">UPI</option>
                </select>
            </div>

            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; font-weight: 600;">Special Requests (Optional)</label>
                <textarea id="specialRequests" rows="3" style="width: 100%; padding: 10px; border: 1px solid #e0e0e0; border-radius: 8px;" placeholder="Any special requirements or notes..."></textarea>
            </div>

            <div style="background: #f0f7ff; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-between; font-size: 18px; font-weight: 600; margin-bottom: 8px;">
                    <span>Total Amount:</span>
                    <span style="color: #10b981;" id="totalAmount">‚Çπ0</span>
                </div>
                <div id="bookingDetails" style="font-size: 13px; color: #666;"></div>
            </div>
            
            <div style="display: flex; gap: 10px;">
                <button type="button" onclick="closeBookingModal()" style="flex: 1; padding: 12px; border: 1px solid #e0e0e0; background: white; border-radius: 8px; cursor: pointer; font-weight: 600;">Cancel</button>
                <button type="submit" style="flex: 1; padding: 12px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">Confirm Booking</button>
            </div>
        </form>
    </div>
</div>

<script src="{{ url_for('static', filename='js/auth.js') }}"></script>
<script src="{{ url_for('static', filename='js/notifications.js') }}"></script>
<script>
let userId, currentVenueId, currentHourlyRate, bookedSlots = [], selectedSlots = [];
let allVenues = [];

async function init() {
    const token = localStorage.getItem('token');
    try {
        const res = await fetch(`${API_URL}/auth/me`, {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        if (res.ok) {
            userId = (await res.json()).user.user_id;
            loadVenues();
        } else {
            window.location.href = '/login';
        }
    } catch (error) {
        console.error('Error initializing:', error);
        window.location.href = '/login';
    }
}

async function loadVenues(sportType = null) {
    const token = localStorage.getItem('token');
    const url = sportType ? `${API_URL}/venue/venues?sport_type=${sportType}` : `${API_URL}/venue/venues`;

    try {
        const res = await fetch(url, {
            headers: { 'Authorization': `Bearer ${token}` }
        });

        if (res.ok) {
            const data = await res.json();
            allVenues = data.venues;
            displayVenues(data.venues);
            updateStats(data.venues);
        } else {
            document.getElementById('venuesGrid').innerHTML = '<p class="loading">Error loading venues</p>';
        }
    } catch (error) {
        console.error('Error loading venues:', error);
        document.getElementById('venuesGrid').innerHTML = '<p class="loading">Error loading venues</p>';
    }
}

function displayVenues(venues) {
    const grid = document.getElementById('venuesGrid');
    if (!venues.length) {
        grid.innerHTML = '<p class="loading">No venues found</p>';
        return;
    }

    grid.innerHTML = venues.map(v => `
        <div class="venue-card" onclick="openBookingModal(${v.venue_id}, '${v.venue_name}', ${v.hourly_rate})">
            <img src="${v.image_url}" class="venue-image" alt="${v.venue_name}" loading="lazy">
            <div class="venue-info">
                <span class="venue-type">${v.sport_type}</span>
                <div class="venue-name">${v.venue_name}</div>
                <div class="venue-location">üìç ${v.location || v.city || 'Location not specified'}</div>
                ${v.description ? `<div style="color: #666; font-size: 14px; margin: 10px 0;">${v.description}</div>` : ''}
                <div style="color: #999; font-size: 13px;">üë• Capacity: ${v.capacity} ${v.facilities ? '| ' + v.facilities : v.amenities ? '| ' + v.amenities : ''}</div>
                <div class="venue-details">
                    <div class="venue-price">‚Çπ${v.hourly_rate}/hr</div>
                    <button class="book-btn" onclick="event.stopPropagation(); openBookingModal(${v.venue_id}, '${v.venue_name}', ${v.hourly_rate})">Book Now</button>
                </div>
            </div>
        </div>
    `).join('');
}

function updateStats(venues) {
    document.getElementById('totalVenues').textContent = venues.length;

    if (venues.length > 0) {
        const uniqueTypes = new Set(venues.map(v => v.sport_type));
        document.getElementById('venueTypes').textContent = uniqueTypes.size;

        const avgRate = Math.round(venues.reduce((sum, v) => sum + v.hourly_rate, 0) / venues.length);
        document.getElementById('avgRate').textContent = `‚Çπ${avgRate}`;
    } else {
        document.getElementById('venueTypes').textContent = '0';
        document.getElementById('avgRate').textContent = '‚Çπ0';
    }
}

function filterVenues(type, btn) {
    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    loadVenues(type);
}

function openBookingModal(venueId, venueName, hourlyRate) {
    currentVenueId = venueId;
    currentHourlyRate = hourlyRate;
    selectedSlots = [];
    document.getElementById('bookingVenueName').textContent = venueName;
    document.getElementById('bookingModal').style.display = 'flex';
    document.getElementById('bookingDate').min = new Date().toISOString().split('T')[0];
    document.getElementById('timeSlotsSection').style.display = 'none';
    document.getElementById('totalAmount').textContent = '‚Çπ0';
    document.getElementById('bookingDetails').textContent = '';
}

function closeBookingModal() {
    document.getElementById('bookingModal').style.display = 'none';
    document.getElementById('bookingForm').reset();
    selectedSlots = [];
    bookedSlots = [];
}

document.getElementById('bookingModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeBookingModal();
    }
});

document.getElementById('bookingDate').addEventListener('change', async function() {
    const date = this.value;
    if (!date) return;
    
    const token = localStorage.getItem('token');
    
    try {
        const res = await fetch(`${API_URL}/venue/venues/${currentVenueId}/availability?date=${date}`, {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        
        if (res.ok) {
            const data = await res.json();
            bookedSlots = data.booked_slots || [];
            selectedSlots = [];
            generateTimeSlots();
            document.getElementById('timeSlotsSection').style.display = 'block';
        } else {
            alert('Failed to load availability for this date');
        }
    } catch (error) {
        console.error('Error loading availability:', error);
        alert('Failed to load availability. Please try again.');
    }
});

function generateTimeSlots() {
    const grid = document.getElementById('timeSlotsGrid');
    const slots = [];
    
    for (let hour = 6; hour < 22; hour++) {
        const startTime = `${hour.toString().padStart(2, '0')}:00:00`;
        const endTime = `${(hour + 1).toString().padStart(2, '0')}:00:00`;
        const isBooked = isSlotBooked(startTime, endTime);
        
        slots.push({ start: startTime, end: endTime, booked: isBooked });
    }
    
    grid.innerHTML = slots.map(slot => {
        const disabled = slot.booked ? 'disabled' : '';
        const bgColor = slot.booked ? '#dc2626' : '#10b981';
        return `
            <button type="button" 
                class="time-slot-btn" 
                data-start="${slot.start}" 
                data-end="${slot.end}"
                ${disabled}
                onclick="toggleTimeSlot('${slot.start}', '${slot.end}')"
                style="border-color: ${bgColor}; background: ${bgColor}; color: white; cursor: ${slot.booked ? 'not-allowed' : 'pointer'}; opacity: ${slot.booked ? '0.5' : '1'};">
                ${formatTime(slot.start)} - ${formatTime(slot.end)}
            </button>
        `;
    }).join('');
}

function isSlotBooked(start, end) {
    return bookedSlots.some(slot => {
        return (start >= slot.start && start < slot.end) || 
                (end > slot.start && end <= slot.end) ||
                (start <= slot.start && end >= slot.end);
    });
}

function toggleTimeSlot(start, end) {
    const index = selectedSlots.findIndex(s => s.start === start && s.end === end);
    
    if (index > -1) {
        selectedSlots.splice(index, 1);
    } else {
        selectedSlots.push({ start, end });
    }
    
    selectedSlots.sort((a, b) => a.start.localeCompare(b.start));
    
    document.querySelectorAll('.time-slot-btn').forEach(btn => {
        const isSelected = selectedSlots.some(s => s.start === btn.dataset.start && s.end === btn.dataset.end);
        
        if (btn.disabled) {
        } else if (isSelected) {
            btn.style.background = '#2563eb';
            btn.style.borderColor = '#2563eb';
        } else {
            btn.style.background = '#10b981';
            btn.style.borderColor = '#10b981';
        }
    });
    
    updateBookingSummary();
}

function updateBookingSummary() {
    if (selectedSlots.length === 0) {
        document.getElementById('totalAmount').textContent = '‚Çπ0';
        document.getElementById('bookingDetails').textContent = '';
        document.getElementById('startTime').value = '';
        document.getElementById('endTime').value = '';
        return;
    }
    
    const firstSlot = selectedSlots[0];
    const lastSlot = selectedSlots[selectedSlots.length - 1];
    
    document.getElementById('startTime').value = firstSlot.start;
    document.getElementById('endTime').value = lastSlot.end;
    
    const totalHours = selectedSlots.length;
    const totalCost = currentHourlyRate * totalHours;
    
    document.getElementById('totalAmount').textContent = `‚Çπ${totalCost.toFixed(2)}`;
    document.getElementById('bookingDetails').textContent = `${totalHours} hour(s) selected √ó ‚Çπ${currentHourlyRate}/hr | ${formatTime(firstSlot.start)} to ${formatTime(lastSlot.end)}`;
}

function formatTime(time) {
    const [hour, min] = time.split(':');
    const h = parseInt(hour);
    const ampm = h >= 12 ? 'PM' : 'AM';
    const displayHour = h > 12 ? h - 12 : h === 0 ? 12 : h;
    return `${displayHour} ${ampm}`;
}

document.getElementById('bookingForm').addEventListener('submit', async e => {
    e.preventDefault();
    
    if (selectedSlots.length === 0) {
        alert('Please select at least one time slot');
        return;
    }
    
    for (let i = 0; i < selectedSlots.length - 1; i++) {
        if (selectedSlots[i].end !== selectedSlots[i + 1].start) {
            alert('‚ö†Ô∏è Please select consecutive time slots only. There are gaps in your selection.');
            return;
        }
    }
    
    const start = selectedSlots[0].start;
    const end = selectedSlots[selectedSlots.length - 1].end;
    
    const token = localStorage.getItem('token');
    
    try {
        const res = await fetch(`${API_URL}/venue/bookings/create`, {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json', 
                'Authorization': `Bearer ${token}` 
            },
            body: JSON.stringify({
                user_id: userId,
                venue_id: currentVenueId,
                booking_date: document.getElementById('bookingDate').value,
                start_time: start,
                end_time: end,
                payment_method: document.getElementById('paymentMethod').value,
                special_requests: document.getElementById('specialRequests').value || null
            })
        });
        
        if (res.ok) {
            alert('‚úÖ Booking confirmed! üéâ');
            closeBookingModal();
            window.location.href = '/my-bookings';
        } else {
            const data = await res.json();
            alert('‚ùå Booking failed: ' + (data.error || 'Unknown error'));
        }
    } catch (error) {
        console.error('Error creating booking:', error);
        alert('‚ùå Booking failed. Please try again.');
    }
});

init();
</script>
<footer class="footer">
        &copy; 2025 CoachMePlay. All rights reserved.
</footer>
</body>
</html>
