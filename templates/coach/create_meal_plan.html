<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Meal Plan - CoachMePlay</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <style>
        body {
            margin: 0;
            font-family: 'Poppins', sans-serif;
            background: #f0f4f8;
            color: #22223a;
        }
        .dashboard {
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
         .navbar {
            background: #2563eb;
            box-shadow: 0 3px 16px rgba(37,99,235,0.12);
            padding: 15px 0;
        }
        .navbar .container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 24px;
        }
        .navbar-brand {
            color: #fff;
            font-weight: 700;
            font-size: 26px;
            letter-spacing: 1px;
            text-decoration: none;
        }
        .navbar-menu {
            list-style: none;
            display: flex;
            gap: 20px;
            margin: 0;
            padding: 0;
            align-items: center;
        }
        .navbar-menu li a {
            color: #fff;
            font-weight: 600;
            text-decoration: none;
            font-size: 16px;
            padding: 6px 16px;
            border-radius: 6px;
            transition: background 0.16s, color 0.16s;
            display: block;
        }
        .navbar-menu li a:hover {
            background: #10b981;
        }
        .footer {
            background: #2563eb;
            padding: 24px 0 16px 0;
            text-align: center;
            margin-top: 48px;
            color: #fff;
            font-size: 16px;
            font-weight: 500;
            box-shadow: 0 -3px 14px #10b98144;
        }
        .footer p {
            margin: 6px 0;
            font-weight: 600;
            letter-spacing: 1px;
        }
        
        .meal-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .meal-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border: 1px solid #e0e0e0;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr;
            gap: 10px;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="nav-brand">CoachMePlay</div>
        <div class="nav-links">
            <a href="/coach/dashboard">Dashboard</a>
            <a href="/coach/nutrition" class="active">Nutrition</a>
            <a href="/messages">Messages</a>
            <div class="notification-icon" id="notificationBell">
                <span>üîî</span>
                <span class="notification-badge" id="notificationCount" style="display: none;">0</span>
            </div>
            <a href="#" id="logoutBtn">Logout</a>
        </div>
    </nav>

    <div class="dashboard-container">
        <div class="page-header">
            <button onclick="window.history.back()" class="btn btn-outline" style="padding: 8px 16px;">
                ‚Üê Back
            </button>
            <h1>Create Meal Plan</h1>
            <p>Design a nutrition plan for your athlete</p>
        </div>

        <div class="content-section">
            <form id="mealPlanForm">
                <h2>Plan Details</h2>
                
                <div class="form-row" style="margin-bottom: 20px;">
                    <div class="form-group">
                        <label>Plan Name *</label>
                        <input type="text" id="planName" placeholder="e.g., Weight Loss Plan" required>
                    </div>
                    
                    <div class="form-group">
                        <label>Select Athlete *</label>
                        <select id="athleteSelect" required>
                            <option value="">Select athlete...</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Daily Calories</label>
                        <input type="number" id="dailyCalories" placeholder="2000" min="1000">
                    </div>
                    
                    <div class="form-group">
                        <label>Protein (g)</label>
                        <input type="number" id="proteinGrams" placeholder="150">
                    </div>
                </div>

                <div class="form-row" style="margin-bottom: 20px;">
                    <div class="form-group">
                        <label>Carbs (g)</label>
                        <input type="number" id="carbsGrams" placeholder="200">
                    </div>
                    
                    <div class="form-group">
                        <label>Fats (g)</label>
                        <input type="number" id="fatsGrams" placeholder="67">
                    </div>
                </div>

                <div class="form-group">
                    <label>Description</label>
                    <textarea id="description" placeholder="Plan goals and notes..." rows="3"></textarea>
                </div>

                <button type="button" onclick="calculateForAthlete()" class="btn btn-secondary" style="margin-bottom: 20px;">
                    üßÆ Auto-Calculate Macros
                </button>

                <hr style="margin: 30px 0;">

                <h2>Meals</h2>

                <!-- Breakfast -->
                <div class="meal-section" id="breakfast-section">
                    <h3>üåÖ Breakfast</h3>
                    <button type="button" onclick="addMeal('breakfast')" class="btn btn-secondary" style="margin-bottom: 15px;">
                        + Add Breakfast Item
                    </button>
                    <div id="breakfast-items"></div>
                </div>

                <!-- Lunch -->
                <div class="meal-section" id="lunch-section">
                    <h3>üåû Lunch</h3>
                    <button type="button" onclick="addMeal('lunch')" class="btn btn-secondary" style="margin-bottom: 15px;">
                        + Add Lunch Item
                    </button>
                    <div id="lunch-items"></div>
                </div>

                <!-- Dinner -->
                <div class="meal-section" id="dinner-section">
                    <h3>üåô Dinner</h3>
                    <button type="button" onclick="addMeal('dinner')" class="btn btn-secondary" style="margin-bottom: 15px;">
                        + Add Dinner Item
                    </button>
                    <div id="dinner-items"></div>
                </div>

                <!-- Snacks -->
                <div class="meal-section" id="snack-section">
                    <h3>üçé Snacks</h3>
                    <button type="button" onclick="addMeal('snack')" class="btn btn-secondary" style="margin-bottom: 15px;">
                        + Add Snack
                    </button>
                    <div id="snack-items"></div>
                </div>

                <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 30px; padding: 15px; font-size: 16px;">
                    üçé Create Meal Plan
                </button>
            </form>
        </div>
    </div>

    <script src="/static/js/auth.js"></script>
    <script src="/static/js/notifications.js"></script>
    <script>
        let coachId = null;
        let mealCounter = 0;

        async function init() {
            const token = localStorage.getItem('token');
            const response = await fetch(`${API_URL}/auth/me`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });

            if (response.ok) {
                const data = await response.json();
                const userId = data.user.user_id;
                
                const coachResponse = await fetch(`${API_URL}/coach/coach-info/${userId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (coachResponse.ok) {
                    const coachData = await coachResponse.json();
                    coachId = coachData.coach_id;
                    loadAthletes();
                }
            }
        }

        async function loadAthletes() {
            const token = localStorage.getItem('token');
            const response = await fetch(`${API_URL}/coach/my-athletes/${coachId}`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });

            if (response.ok) {
                const data = await response.json();
                const select = document.getElementById('athleteSelect');
                select.innerHTML = '<option value="">Select athlete...</option>' +
                    data.athletes.map(a => `<option value="${a.athlete_id}">${a.full_name}</option>`).join('');
                
                const selectedId = localStorage.getItem('selected_athlete_id');
                if (selectedId) {
                    select.value = selectedId;
                    localStorage.removeItem('selected_athlete_id');
                }
            }
        }

        async function calculateForAthlete() {
            const athleteId = document.getElementById('athleteSelect').value;
            if (!athleteId) {
                alert('Please select an athlete first');
                return;
            }

            const token = localStorage.getItem('token');
            const response = await fetch(`${API_URL}/coach/calculate-nutrition/${athleteId}`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });

            if (response.ok) {
                const data = await response.json();
                document.getElementById('dailyCalories').value = data.daily_calories;
                document.getElementById('proteinGrams').value = data.protein_grams;
                document.getElementById('carbsGrams').value = data.carbs_grams;
                document.getElementById('fatsGrams').value = data.fats_grams;
                
                alert('Macros calculated based on athlete profile!');
            }
        }

        function addMeal(mealType) {
            mealCounter++;
            const container = document.getElementById(`${mealType}-items`);
            
            const mealHTML = `
                <div class="meal-item" id="meal-${mealCounter}">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <input type="text" placeholder="Meal name" class="meal-name" style="flex: 1; margin-right: 10px;" required>
                        <button type="button" onclick="removeMeal(${mealCounter})" class="btn btn-outline" style="padding: 6px 12px;">
                            üóëÔ∏è Remove
                        </button>
                    </div>
                    <div class="form-row">
                        <input type="number" placeholder="Calories" class="meal-calories" min="0">
                        <input type="number" placeholder="Protein (g)" class="meal-protein" min="0">
                        <input type="number" placeholder="Carbs (g)" class="meal-carbs" min="0">
                        <input type="number" placeholder="Fats (g)" class="meal-fats" min="0">
                    </div>
                    <textarea placeholder="Ingredients (optional)" class="meal-ingredients" rows="2" style="width: 100%; margin-top: 10px; padding: 8px; border: 1px solid #e0e0e0; border-radius: 6px;"></textarea>
                    <textarea placeholder="Instructions (optional)" class="meal-instructions" rows="2" style="width: 100%; margin-top: 10px; padding: 8px; border: 1px solid #e0e0e0; border-radius: 6px;"></textarea>
                </div>
            `;
            
            container.insertAdjacentHTML('beforeend', mealHTML);
        }

        function removeMeal(mealId) {
            document.getElementById(`meal-${mealId}`).remove();
        }

        document.getElementById('mealPlanForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const athleteId = document.getElementById('athleteSelect').value;
            if (!athleteId) {
                alert('Please select an athlete');
                return;
            }

            // Collect all meals
            const meals = [];
            ['breakfast', 'lunch', 'dinner', 'snack'].forEach(mealType => {
                const items = document.querySelectorAll(`#${mealType}-items .meal-item`);
                items.forEach(item => {
                    meals.push({
                        meal_type: mealType,
                        meal_name: item.querySelector('.meal-name').value,
                        calories: item.querySelector('.meal-calories').value,
                        protein: item.querySelector('.meal-protein').value,
                        carbs: item.querySelector('.meal-carbs').value,
                        fats: item.querySelector('.meal-fats').value,
                        ingredients: item.querySelector('.meal-ingredients').value,
                        instructions: item.querySelector('.meal-instructions').value
                    });
                });
            });

            const planData = {
                coach_id: coachId,
                athlete_id: athleteId,
                plan_name: document.getElementById('planName').value,
                description: document.getElementById('description').value,
                daily_calories: document.getElementById('dailyCalories').value,
                protein_grams: document.getElementById('proteinGrams').value,
                carbs_grams: document.getElementById('carbsGrams').value,
                fats_grams: document.getElementById('fatsGrams').value,
                meals: meals
            };

            const token = localStorage.getItem('token');
            const response = await fetch(`${API_URL}/coach/meal-plans/create`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify(planData)
            });

            if (response.ok) {
                alert('Meal plan created successfully! üçé');
                window.location.href = '/coach/nutrition';
            } else {
                const error = await response.json();
                alert('Error: ' + (error.error || 'Failed to create plan'));
            }
        });

        init();
    </script>
    <footer class="footer">
        &copy; 2025 CoachMePlay. All rights reserved.
    </footer>
</body>
</html>
