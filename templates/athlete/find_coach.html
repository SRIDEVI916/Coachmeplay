<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Find a Coach - CoachMePlay</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
        .find-coach-container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .coaches-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px; margin-top: 30px; }
        .coach-card { background: white; padding: 25px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); transition: transform 0.2s; }
        .coach-card:hover { transform: translateY(-5px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .coach-header { display: flex; align-items: center; margin-bottom: 15px; }
        .coach-avatar { width: 60px; height: 60px; border-radius: 50%; background: linear-gradient(135deg, #2563eb, #10b981); display: flex; align-items: center; justify-content: center; color: white; font-size: 24px; font-weight: bold; margin-right: 15px; overflow: hidden; }
        .coach-avatar img { width: 100%; height: 100%; object-fit: cover; }
        .coach-name { font-size: 20px; font-weight: bold; color: #1f2937; }
        .specialization { display: inline-block; background: #dbeafe; color: #1e40af; padding: 5px 12px; border-radius: 15px; font-size: 14px; margin: 10px 0; }
        .coach-details { color: #6b7280; font-size: 14px; margin: 10px 0; }
        .action-buttons { display: flex; gap: 10px; margin-top: 15px; }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="container">
            <a href="/" class="navbar-brand">CoachMePlay</a>
            <ul class="navbar-menu">
                <li><a href="/athlete/dashboard">Dashboard</a></li>
                <li><a href="/athlete/performance">Performance</a></li>
                <li><a href="/athlete/find-coach">Find Coach</a></li>
                <li><a href="/athlete/profile">Profile</a></li>
                <li><a href="/athlete/analytics">Analytics</a></li>
                <li><a href="#" onclick="logout(); return false;">Logout</a></li>
            </ul>
        </div>
    </nav>

    <div class="find-coach-container">
        <h1>üë®‚Äçüè´ Find Your Coach</h1>
        <p style="color: #6b7280; margin-bottom: 20px;">Connect with experienced coaches to achieve your sports goals</p>
        
        <div id="coachesGrid" class="coaches-grid">
            <p>Loading coaches...</p>
        </div>
    </div>

    <!-- Request Modal -->
    <div id="requestModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
        <div style="background: white; padding: 30px; border-radius: 8px; max-width: 500px; width: 90%;">
            <h2>Send Coaching Request</h2>
            <div id="modalAlert" style="display: none;"></div>
            <form id="requestForm">
                <div class="form-group">
                    <label>Coach: <span id="coachNameModal"></span></label>
                </div>
                <div class="form-group">
                    <label for="requestMessage">Your Message</label>
                    <textarea id="requestMessage" rows="5" required placeholder="Tell the coach why you'd like them to coach you..."></textarea>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button type="submit" class="btn btn-primary">Send Request</button>
                    <button type="button" class="btn" onclick="closeModal()" style="background: #6b7280; color: white;">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <script src="{{ url_for('static', filename='js/auth.js') }}"></script>
    <script>
    (function() {
        const API_URL = 'http://localhost:5000/api';
        let athleteId = null;
        let selectedCoachId = null;
        let selectedCoachName = '';
        
        checkAuth();
        
        async function init() {
            const userId = localStorage.getItem('user_id');
            try {
                const res = await fetch(API_URL + '/athlete/athlete-info/' + userId, { headers: getAuthHeader() });
                const data = await res.json();
                if (res.ok) {
                    athleteId = data.athlete_id;
                    loadCoaches();
                }
            } catch(e) { console.error(e); }
        }
        
        async function loadCoaches() {
            try {
                const res = await fetch(API_URL + '/coach/coaches', { headers: getAuthHeader() });
                const data = await res.json();
                const grid = document.getElementById('coachesGrid');
                
                if (data.coaches && data.coaches.length > 0) {
                    grid.innerHTML = data.coaches.map(coach => {
                        const initial = coach.full_name.charAt(0).toUpperCase();
                        const avatarHtml = coach.profile_picture 
                            ? `<img src="/${coach.profile_picture}" alt="${coach.full_name}">` 
                            : initial;
                        
                        return `
                            <div class="coach-card">
                                <div class="coach-header">
                                    <div class="coach-avatar">${avatarHtml}</div>
                                    <div>
                                        <div class="coach-name">${coach.full_name}</div>
                                        <div style="color: #6b7280; font-size: 14px;">${coach.email}</div>
                                    </div>
                                </div>
                                ${coach.specialization ? '<span class="specialization">' + coach.specialization + '</span>' : ''}
                                <div class="coach-details">
                                    ${coach.experience_years ? 'üìÖ ' + coach.experience_years + ' years experience' : ''}
                                </div>
                                <div class="coach-details">
                                    ${coach.hourly_rate ? 'üí∞ $' + coach.hourly_rate + '/hour' : 'Rate not set'}
                                </div>
                                <div class="coach-details" style="max-height: 60px; overflow: hidden; text-overflow: ellipsis;">
                                    ${coach.bio || 'No bio available'}
                                </div>
                                <div class="action-buttons">
                                    <a href="/athlete/coach-detail?coach_id=${coach.coach_id}" style="flex: 1; text-decoration: none;">
                                        <button class="btn btn-primary" style="width: 100%;">View Profile</button>
                                    </a>
                                    <button class="btn btn-success" style="flex: 1;" onclick="openRequestModal(${coach.coach_id}, '${coach.full_name}')">
                                        Request
                                    </button>
                                </div>
                            </div>
                        `;
                    }).join('');
                } else {
                    grid.innerHTML = '<p>No coaches available yet.</p>';
                }
            } catch(e) {
                console.error(e);
                document.getElementById('coachesGrid').innerHTML = '<p>Error loading coaches.</p>';
            }
        }
        
        window.openRequestModal = function(coachId, coachName) {
            selectedCoachId = coachId;
            selectedCoachName = coachName;
            document.getElementById('coachNameModal').textContent = coachName;
            document.getElementById('requestModal').style.display = 'flex';
        };
        
        window.closeModal = function() {
            document.getElementById('requestModal').style.display = 'none';
            document.getElementById('requestForm').reset();
            document.getElementById('modalAlert').style.display = 'none';
        };
        
        document.getElementById('requestForm').onsubmit = async function(e) {
            e.preventDefault();
            
            const message = document.getElementById('requestMessage').value;
            
            try {
                const res = await fetch(API_URL + '/coach/coaching-request', {
                    method: 'POST',
                    headers: getAuthHeader(),
                    body: JSON.stringify({
                        athlete_id: athleteId,
                        coach_id: selectedCoachId,
                        message: message
                    })
                });
                
                const data = await res.json();
                
                if (res.ok) {
                    const alertDiv = document.getElementById('modalAlert');
                    alertDiv.className = 'alert alert-success';
                    alertDiv.textContent = 'Request sent successfully! üéâ';
                    alertDiv.style.display = 'block';
                    
                    setTimeout(() => {
                        closeModal();
                    }, 2000);
                } else {
                    const alertDiv = document.getElementById('modalAlert');
                    alertDiv.className = 'alert alert-error';
                    alertDiv.textContent = data.error;
                    alertDiv.style.display = 'block';
                }
            } catch(e) {
                console.error(e);
            }
        };
        
        init();
    })();
    </script>
</body>
</html>